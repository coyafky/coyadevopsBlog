---
title: "WebSocket"
outline: deep
desc: "WebSocket"
tags: "Network"
updateTime: "2025-05-14 14:11"
---

### WebSocket：让浏览器也能玩转“TCP”

在互联网的世界里，HTTP协议是应用层的“王者”，几乎所有的Web应用都离不开它。然而，HTTP的“请求-应答”模式却有一个致命的缺陷：它不适合“实时通信”。为了解决这个问题，**WebSocket**应运而生。今天，我们就来聊聊WebSocket的原理、特点以及它如何弥补HTTP的不足。

---

### **为什么需要WebSocket？**

HTTP协议虽然强大，但它有一个天生的缺陷：它是“半双工”的。换句话说，虽然HTTP可以双向通信，但同一时刻只能有一个方向有动作。更关键的是，HTTP是“被动”的——服务器只能在客户端发起请求后才能响应，无法主动向客户端发送数据。

这种“被动”模式让HTTP难以胜任一些需要实时通信的场景，比如：

- **动态页面**：实时更新股票行情、天气信息等。
- **即时消息**：聊天应用、在线客服。
- **网络游戏**：多人在线对战、实时同步玩家状态。

在WebSocket出现之前，开发者通常使用“轮询”（Polling）来模拟实时通信。所谓轮询，就是客户端不停地向服务器发送HTTP请求，询问是否有新数据。如果轮询的频率较高，就能近似实现“实时通信”。然而，轮询的缺点也很明显：

- **带宽浪费**：即使没有新数据，客户端也会频繁发送无效请求。
- **性能开销**：服务器需要处理大量无意义的查询请求。

于是，**WebSocket**诞生了。它是一种全新的通信协议，专门解决HTTP“请求-应答”模式的缺陷。

---

### **WebSocket的特点**

### **1. 全双工通信**

WebSocket是一种“全双工”的通信协议，客户端和服务器可以随时向对方发送数据，而不需要像HTTP那样“你拍一，我拍一”。服务器可以主动向客户端推送数据，不再需要客户端轮询。这种机制显著提高了实时通信的效率。

### **2. 轻量级协议**

WebSocket的帧结构非常简单，只有2~14字节的头部。相比HTTP的复杂报文，WebSocket的开销更小，传输效率更高。

### **3. 二进制帧结构**

WebSocket使用二进制帧来传输数据，支持纯文本和二进制内容。帧头包含几个关键字段：

- **FIN**：表示消息是否结束。
- **Opcode**：帧类型，比如文本、二进制、关闭连接等。
- **Payload len**：帧内容的长度。
- **Masking-key**：客户端发送的数据必须经过掩码加密（异或操作）。

### **4. HTTP兼容性**

WebSocket的另一个特点是与HTTP的高度兼容性。它通过HTTP协议完成握手，然后升级为WebSocket协议。这样，WebSocket可以“伪装”成HTTP协议，轻松穿透防火墙和浏览器沙盒。

---

### **WebSocket的工作原理**

### **1. 握手过程**

WebSocket的握手过程非常巧妙。它利用了HTTP协议的“升级”特性，通过一个特殊的HTTP请求完成协议切换。

- **客户端请求**：
    
    ```
    GET /chat HTTP/1.1
    Host: example.com
    Connection: Upgrade
    Upgrade: websocket
    Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
    Sec-WebSocket-Version: 13
    
    ```
    
    关键字段解释：
    
    - `Connection: Upgrade`：表示请求升级协议。
    - `Upgrade: websocket`：指定升级为WebSocket协议。
    - `Sec-WebSocket-Key`：一个Base64编码的随机数，用于握手验证。
    - `Sec-WebSocket-Version`：协议版本号，当前必须是13。
- **服务器响应**：
    
    ```
    HTTP/1.1 101 Switching Protocols
    Connection: Upgrade
    Upgrade: websocket
    Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=
    
    ```
    
    服务器通过`Sec-WebSocket-Accept`字段验证客户端的握手请求。它的值是将`Sec-WebSocket-Key`加上一个固定UUID后计算SHA-1摘要，再用Base64编码生成的。
    

握手完成后，双方就可以使用WebSocket协议进行通信了。

### **2. 数据传输**

握手完成后，HTTP协议退出舞台，后续的通信完全由WebSocket接管。数据以二进制帧的形式传输，客户端和服务器可以随时发送消息。

---

### **WebSocket的典型应用场景**

### **1. 实时聊天**

WebSocket非常适合用于即时通讯应用，比如在线聊天室、客服系统等。服务器可以主动推送新消息，用户无需刷新页面即可实时看到更新。

### **2. 在线游戏**

在多人在线游戏中，WebSocket可以用来实时同步玩家状态和游戏事件。相比轮询，WebSocket的全双工特性能够显著降低延迟，提升游戏体验。

### **3. 实时数据展示**

股票行情、天气信息、体育比分等需要实时更新的数据展示场景，WebSocket可以实现秒级甚至毫秒级的数据更新，让用户随时掌握最新动态。

### **4. 协作工具**

在线文档编辑、协同绘图等工具需要多人实时协作，WebSocket可以实现用户之间的实时同步。

---

### **WebSocket与HTTP/2的对比**

虽然WebSocket和HTTP/2都可以从HTTP/1升级，并且都采用二进制帧结构，但它们的设计目标和应用场景有很大不同：

| 特性 | WebSocket | HTTP/2 |
| --- | --- | --- |
| **通信模式** | 全双工 | 半双工 |
| **实时性** | 高，适合实时通信 | 较低，适合传统Web应用 |
| **多路复用** | 不支持 | 支持，提升传输效率 |
| **头部压缩** | 不支持 | 支持，减少开销 |
| **适用场景** | 聊天、游戏、实时数据展示 | 静态资源加载、API调用 |

---

### **总结**

WebSocket的出现，填补了HTTP协议在实时通信领域的空白。它通过全双工通信、轻量级帧结构和HTTP兼容性，为开发者提供了一个强大的工具，让浏览器也能像本地应用一样实现实时通信。

用一句话总结WebSocket的作用：

**“它让浏览器不再受限于HTTP，开启了实时通信的新时代。”**

